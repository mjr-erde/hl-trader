#!/usr/bin/env bash
# erde — start the hl-trader agent.
# Run from the directory where hl-trader is installed.
# Add to PATH: export PATH="$PATH:/path/to/hl-trader/bin"

set -euo pipefail

BOLD="\033[1m"
GREEN="\033[32m"
CYAN="\033[36m"
YELLOW="\033[33m"
RED="\033[31m"
RESET="\033[0m"

info() { echo -e "  ${CYAN}→${RESET} $1"; }
warn() { echo -e "  ${YELLOW}!${RESET} $1"; }

# ── Installation detection ────────────────────────────────────────────────────
# All three must be true (checked in CWD, not the script location)

if [ ! -f "package.json" ] || [ ! -d "node_modules" ] || [ ! -d "hyperliquid-trader/src" ]; then
  echo ""
  echo -e "  ${YELLOW}!${RESET} No hl-trader installation found in the current directory."
  echo "    → Run this command from your hl-trader installation directory."
  echo ""
  read -rp "  Install hl-trader here from the latest release? [y/N]: " choice
  echo ""
  if [[ "$choice" =~ ^[Yy]$ ]]; then
    echo -e "  ${CYAN}→${RESET} Cloning https://github.com/your-github-org/hl-trader ..."
    git clone https://github.com/your-github-org/hl-trader .
    echo ""
    bash install.sh
  else
    info "To install manually:"
    info "  git clone https://github.com/your-github-org/hl-trader"
    info "  cd hl-trader && bash install.sh"
    echo ""
  fi
  exit 0
fi

# ── Start server if not running ───────────────────────────────────────────────

if ! curl -sf http://localhost:3000/api/info &>/dev/null; then
  info "Starting web dashboard on :3000..."
  npm run server &>/dev/null &
  disown
  sleep 1
fi

# ── Launch agent (forward all flags) ─────────────────────────────────────────

exec npx tsx hyperliquid-trader/src/agent.ts "$@"
